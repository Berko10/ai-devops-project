#!/bin/bash

set -e

echo "ğŸ” ××—×¤×© ××©××‘×™× ×§×™×™××™× ×‘-AWS..."

existing_resources=$(aws resourcegroupstaggingapi get-resources --output json | jq -r '.ResourceTagMappingList[].ResourceARN')

cd "$(dirname "$0")"

terraform init -input=false

echo "ğŸš€ ×‘×•×“×§ ××™×œ×• ××©××‘×™× × ×™×ª×Ÿ ×œ×™×™×‘× ×œ-Terraform..."

while IFS= read -r arn; do
  # ×—×™×œ×•×¥ ×¡×•×’ ×”×©×™×¨×•×ª ×•×”×©× ××”-ARN
  service=$(echo "$arn" | cut -d':' -f6 | cut -d'/' -f1)
  identifier=$(echo "$arn" | cut -d'/' -f2-)

  # ××¦×™××ª ×©× ×”-RESOURCE ×‘×§×•×“ Terraform ×©×œ×š
  tf_resource=$(terraform state list 2>/dev/null | grep "$identifier" || true)

  if [ -z "$tf_resource" ]; then
    # ×× ×œ× ×§×™×™× ×‘-STATE, × × ×¡×” ×œ×™×™×‘×
    echo "ğŸ“¦ ××™×™×‘×: $arn (service: $service, id: $identifier)"

    # × × ×™×— ×©×™×© ×œ×š ××©××‘×™× ×‘×©× ×ª×•××, ×œ×“×•×’××”: aws_lb.my_alb
    # ××– ×ª×•×›×œ ×œ×‘×¦×¢:
    match=$(grep -rl "$identifier" . | grep .tf | head -n 1)

    if [ -n "$match" ]; then
      resource_name=$(grep "$identifier" "$match" | grep 'resource "' | awk '{print $2"."$3}' | tr -d '"')
      echo "ğŸ¯ ×ª×•×× ×œ-Terraform resource: $resource_name"
      terraform import "$resource_name" "$identifier" || echo "âš ï¸ Import × ×›×©×œ ××• ×›×‘×¨ ×§×™×™×"
    else
      echo "âš ï¸ ×œ× × ××¦× ×§×•×‘×¥ ×©××ª××™× ×œ-$identifier, ××“×œ×’..."
    fi
  else
    echo "âœ… ×›×‘×¨ ×§×™×™× ×‘-state: $tf_resource"
  fi
done <<< "$existing_resources"
